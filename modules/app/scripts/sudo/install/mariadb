#!/bin/bash
#C# --system

# Par défaut, on installe MariaDB 11.4 LTS depuis les dépôts officiels
# Utiliser --system pour installer depuis les dépôts système
if [ "$system" != "on" ]; then
  apt install apt-transport-https curl -y

  source /etc/os-release

  mkdir -p /etc/apt/keyrings
  curl -o /etc/apt/keyrings/mariadb-keyring.pgp 'https://mariadb.org/mariadb_release_signing_key.pgp'

  if [ "$ID" == "ubuntu" ]; then
    echo "
deb [signed-by=/etc/apt/keyrings/mariadb-keyring.pgp] https://deb.mariadb.org/11.4/ubuntu $VERSION_CODENAME main
    " >/etc/apt/sources.list.d/mariadb.list
  else
    echo "
deb [signed-by=/etc/apt/keyrings/mariadb-keyring.pgp] https://deb.mariadb.org/11.4/debian $VERSION_CODENAME main
    " >/etc/apt/sources.list.d/mariadb.list
  fi

  apt update -y
fi

apt install -y mariadb-server

# Désactiver les plugins de compression non disponibles dans MariaDB 11.4
# Ces fichiers de configuration causent des erreurs au démarrage
for provider in provider_bzip2 provider_lz4 provider_lzma provider_lzo provider_snappy; do
  if [ -f /etc/mysql/mariadb.conf.d/${provider}.cnf ]; then
    mv /etc/mysql/mariadb.conf.d/${provider}.cnf /etc/mysql/mariadb.conf.d/${provider}.cnf.disabled 2>/dev/null || true
  fi
done

# Redémarrer MariaDB pour appliquer les changements
systemctl restart mariadb 2>/dev/null || service mariadb restart 2>/dev/null || true

[ ! -f /root/.my.cnf ] && tb mysql sudo/install/root --force
